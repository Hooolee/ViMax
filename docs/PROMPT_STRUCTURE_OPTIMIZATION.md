# 提示词结构优化说明

## 优化内容

优化了 `ReferenceImageSelector` agent 生成的 text_prompt 结构，使其更符合 AI 图像生成器的理解逻辑。

## 修改的文件

- `agents/reference_image_selector.py`

## 新的提示词结构

### 📋 结构顺序

提示词现在必须按照以下顺序组织：

1. **镜头信息** - 镜头类型、角度、构图
2. **主要人物** - 画面中的主要角色及其特征（引用参考图像）
3. **次要元素** - 环境、背景、光照等其他元素（引用参考图像）

### ✅ 优化前 vs 优化后

**优化前（混乱的结构）：**

```
侦探检查证据（参考图像0获取侦探外貌：黑色短发、锐利眼神），
站在灯光昏暗的博物馆中（参考图像1获取环境：破碎展示柜、环境光照）
```

**优化后（结构化）：**

```
高角度全景镜头。
一名侦探（参考图像0获取角色外观：黑色短发、锐利眼神、深色外套）站在画面中心，正在检查证据。
背景是灯光昏暗的博物馆大厅（参考图像1获取环境：破碎展示柜、环境光照）。
```

### 🎯 优势

1. **层次清晰**：先镜头 → 再人物 → 后环境，符合视觉理解的自然顺序
2. **重点突出**：主要角色信息放在中间位置，更容易被 AI 识别
3. **逻辑连贯**：从整体构图到具体元素，逐步细化描述
4. **易于解析**：AI 图像生成器更容易理解提示词的意图

### 📝 实际应用示例

#### 示例 1：单人场景

```
高角度全景镜头。
夜晚的摩天大楼天台上，一名身穿深灰色风衣的男子（参考图像0获取服装和背对镜头的站姿）独自站在天台边缘，身形笔挺。
背景是城市的霓虹灯在下方延伸成一片模糊的光海，几名警员和法医在便携式强光灯下工作。
```

#### 示例 2：多人互动场景

```
过肩镜头。
画面前景左下角是爱丽丝的肩膀。
画面中心是鲍勃（参考图像0获取外貌：面部特征、发型、服装），身体转向面对摄像机，表情从惊讶转为喜悦。
背景是超市过道（参考图像1获取环境：货架、照明）。
```

#### 示例 3：特写镜头

```
特写镜头。
侦探的手（参考图像0获取手部特征：戴手套）正在仔细检查一只皮鞋鞋尖上的白色刮痕。
背景虚化，可以看到天台地面的粗糙质感（参考图像1获取环境纹理）。
```

## 技术实现

### 修改的提示词模板

1. **`system_prompt_template_select_reference_images_only_text`** - 纯文本模式
2. **`system_prompt_template_select_reference_images_multimodal`** - 多模态模式
3. **`generate_prompt_for_selected_images`** - 提示词生成方法

### 关键变更

- 添加了"**text_prompt 的结构要求（重要）**"章节
- 提供了结构化的示例
- 更新了所有相关的描述和指南
- 在 `RefImageIndicesAndTextPrompt` 模型中更新了字段描述和示例

## 预期效果

通过这个优化，生成的图像应该：

- ✅ 构图更准确（明确的镜头信息）
- ✅ 主体更清晰（人物描述在突出位置）
- ✅ 背景更协调（环境信息组织有序）
- ✅ 整体质量更高（AI 更容易理解提示词意图）

## 测试建议

在使用优化后的代码时，可以对比生成的图像质量：

1. 检查镜头构图是否符合预期
2. 检查主要人物是否清晰突出
3. 检查背景环境是否合理
4. 检查整体视觉效果是否提升

## 兼容性

✅ 向后兼容 - 不影响现有功能
✅ 自动生效 - 所有使用 ReferenceImageSelector 的流程都会受益
✅ 无需额外配置 - 开箱即用

---

**修改日期**: 2025-11-07  
**修改人**: AI Assistant  
**相关 Issue**: 优化提示词结构以提升图像生成质量
