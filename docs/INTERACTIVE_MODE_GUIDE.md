# 交互模式使用指南

## 概述

本项目已添加交互模式功能，允许在每个 agent 运行结束后与用户进行交互，等待用户确认后才继续下一步。

## 修改的文件

### 1. `pipelines/idea2video_pipeline.py`

#### 新增功能

- **`interactive_mode` 参数**: 控制是否启用交互模式
- **`wait_for_user_confirmation()` 方法**: 等待用户输入并处理用户选择

#### 修改的方法

以下方法均添加了用户交互功能，在执行完成后会暂停并等待用户确认：

1. **`develop_story()`** - 故事发展阶段

   - 显示故事内容预览（前 500 字符）
   - 支持继续、重新运行或退出

2. **`write_script_based_on_story()`** - 编写剧本阶段

   - 显示场景数量和前 3 个场景的预览
   - 支持继续、重新运行或退出

3. **`plan_scenes()`** - 场景规划阶段

   - 显示所有场景的位置、时间和描述
   - 支持继续、重新运行或退出

4. **`extract_characters()`** - 角色提取阶段

   - 显示所有提取的角色及其描述
   - 支持继续、重新运行或退出

5. **`generate_character_portraits()`** - 角色肖像生成阶段

   - 显示所有角色的肖像文件路径
   - 支持继续、重新运行或退出

6. **场景视频生成** - 每个场景视频生成后

   - 显示场景视频路径
   - 支持继续、重新运行或退出

7. **最终视频生成完成**
   - 显示最终视频路径
   - 等待用户确认

### 2. `main_idea2video.py`

#### 新增配置

```python
# 是否启用交互模式 (True=每个agent运行后等待用户确认, False=自动运行所有步骤)
interactive_mode = True
```

## 使用方法

### 启用交互模式（默认）

在 `main_idea2video.py` 中设置：

```python
interactive_mode = True
```

运行脚本后，每个 agent 完成任务后会显示：

```
================================================================================
🎯 [阶段名称] 阶段已完成！
================================================================================
请选择：
  [c] 继续下一步
  [r] 重新运行当前步骤
  [q] 退出程序
================================================================================
请输入选项 (c/r/q):
```

### 用户选项说明

- **`c` (Continue)**: 继续执行下一步
- **`r` (Retry)**: 重新运行当前步骤（会删除该步骤生成的文件）
- **`q` (Quit)**: 退出程序

### 禁用交互模式

如果希望自动运行所有步骤而不需要用户交互，可以设置：

```python
interactive_mode = False
```

此时程序会自动执行所有步骤，不会暂停等待用户输入。

## 特性说明

### 1. 自动清理和重新生成

当用户选择 `[r]` 重新运行当前步骤时，系统会：

- 删除该步骤生成的所有文件
- 重新执行该步骤
- 再次等待用户确认

### 2. 内容预览

在每个阶段完成后，系统会显示：

- **故事阶段**: 显示故事内容的前 500 字符
- **剧本阶段**: 显示场景数量和前 3 个场景的内容预览
- **场景规划阶段**: 显示所有场景的详细信息
- **角色提取阶段**: 显示所有角色的名称和描述
- **角色肖像生成阶段**: 显示所有生成的肖像文件路径
- **场景视频生成阶段**: 显示每个场景视频的路径

### 3. 安全退出

- 支持 `Ctrl+C` 中断
- 支持 `EOF` 信号
- 优雅退出，不会导致数据损坏

## 示例运行流程

```
1. 📖 Develop Story (发展故事)
   ↓ 完成后显示内容预览
   ↓ 等待用户输入 [c/r/q]

2. 📝 Write Script (编写剧本)
   ↓ 完成后显示场景信息
   ↓ 等待用户输入 [c/r/q]

3. 🎬 Plan Scenes (场景规划)
   ↓ 完成后显示场景详情
   ↓ 等待用户输入 [c/r/q]

4. 👥 Extract Characters (提取角色)
   ↓ 完成后显示角色列表
   ↓ 等待用户输入 [c/r/q]

5. 🎨 Generate Character Portraits (生成角色肖像)
   ↓ 完成后显示肖像文件
   ↓ 等待用户输入 [c/r/q]

6. 🎥 Scene Video Generation (场景视频生成)
   ↓ 每个场景完成后等待确认
   ↓ 等待用户输入 [c/r/q]

7. 🎉 Final Video Generation Complete (最终视频完成)
   ↓ 显示最终视频路径
   ↓ 等待用户确认
```

## 注意事项

1. **文件缓存**: 如果某个步骤的输出文件已存在，会直接加载而不重新生成（除非选择重新运行）
2. **重新运行**: 选择重新运行会删除当前步骤的所有输出文件，请谨慎操作
3. **中断恢复**: 如果程序中断，下次运行时会从已完成的步骤继续（基于文件缓存）
4. **非交互环境**: 在非交互环境（如 CI/CD）中，请将 `interactive_mode` 设置为 `False`

## 技术细节

### 实现原理

- 使用 `while True` 循环包装每个主要的 agent 方法
- 在每个方法执行完成后调用 `wait_for_user_confirmation()`
- 根据用户选择决定是继续 (`break`)、重试 (`continue`) 还是退出 (`sys.exit()`)

### 错误处理

- 捕获 `EOFError` 和 `KeyboardInterrupt` 异常
- 优雅地退出程序，不会导致资源泄漏

### 兼容性

- 完全向后兼容，不影响现有功能
- 可通过 `interactive_mode=False` 关闭交互模式
