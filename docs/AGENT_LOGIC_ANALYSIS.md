# ViMax Agent 逻辑分析文档

本文档详细分析了 ViMax 项目中每个 Agent 的核心逻辑、职责和潜在优化点。

---

## 目录

1. [Screenwriter (编剧)](#1-screenwriter-编剧)
2. [CharacterExtractor (角色提取器)](#2-characterextractor-角色提取器)
3. [CharacterPortraitsGenerator (角色肖像生成器)](#3-characterportraitsgenerator-角色肖像生成器)
4. [StoryboardArtist (分镜艺术家)](#4-storyboardartist-分镜艺术家)
5. [CameraImageGenerator (镜头图像生成器)](#5-cameraimagegenerator-镜头图像生成器)
6. [ReferenceImageSelector (参考图选择器)](#6-referenceimageselector-参考图选择器)
7. [BestImageSelector (最佳图像选择器)](#7-bestimageselector-最佳图像选择器)
8. [Pipeline 流程概览](#8-pipeline-流程概览)
9. [优化建议总结](#9-优化建议总结)

---

## 1. Screenwriter (编剧)

### 核心职责

将用户的创意想法转化为完整的故事，并进一步改编成可拍摄的剧本。

### 主要方法

#### `develop_story()`

- **输入**: idea (创意概念), user_requirement (用户需求)
- **输出**: 完整的故事文本
- **逻辑流程**:
  1. 使用详细的系统提示词，要求生成符合特定结构的故事
  2. 包含角色介绍、故事大纲、完整叙事等要素
  3. 支持目标受众、类型、长度等定制化需求

#### `write_script_based_on_story()`

- **输入**: story (故事文本), user_requirement (用户需求)
- **输出**: List[str] - 按场景分割的剧本列表
- **逻辑流程**:
  1. 将故事改编成符合影视制作标准的剧本
  2. 按照时间和地点进行场景划分
  3. 包含对白、动作描述、场景设置等元素
  4. 使用 Pydantic 解析器确保输出格式标准化

### 优化建议

- ✅ **当前优势**: 提示词设计专业，覆盖了故事创作的核心要素
- 🔄 **可优化项**:
  - 考虑添加故事一致性检查（角色行为、时间线逻辑等）
  - 可以增加对不同类型故事的模板支持（科幻、悬疑、爱情等）
  - 剧本生成时可以考虑制作预算约束（场景数量、特效复杂度等）

---

## 2. CharacterExtractor (角色提取器)

### 核心职责

从剧本中识别并提取所有主要角色的详细信息。

### 主要方法

#### `extract_characters()`

- **输入**: script (剧本文本)
- **输出**: List[CharacterInScene] - 角色信息列表
- **逻辑流程**:
  1. 分析剧本识别所有重要角色
  2. 为每个角色生成:
     - 标识符（名字或描述性称呼）
     - 静态特征（外貌、体型等不变特征）
     - 动态特征（服装、配饰等可变特征）
  3. 合并同一角色的不同称呼
  4. 如果剧本中缺少描述，会基于上下文推断角色特征
  5. 使用重试机制确保提取质量

### 关键特点

- **角色去重**: 能识别同一角色的不同称呼方式
- **特征补全**: 当剧本描述不完整时，会智能补充角色特征
- **视觉化导向**: 特征描述专注于可视化元素，便于后续图像生成

### 优化建议

- ✅ **当前优势**: 静态/动态特征分离设计合理，便于多视角生成
- 🔄 **可优化项**:
  - 可以添加角色关系图谱（谁是谁的朋友/敌人等）
  - 考虑记录角色在不同场景的服装变化
  - 可以提取角色的情感状态变化时间线

---

## 3. CharacterPortraitsGenerator (角色肖像生成器)

### 核心职责

为每个角色生成标准化的多角度肖像（正面、侧面、背面），用于后续镜头中保持角色一致性。

### 主要方法

#### `generate_front_portrait()`

- **输入**: character (角色信息), style (视觉风格)
- **输出**: ImageOutput - 正面全身肖像
- **逻辑**: 基于角色静态和动态特征生成标准正面视角

#### `generate_side_portrait()` & `generate_back_portrait()`

- **输入**: character, front_image_path (正面肖像路径)
- **输出**: ImageOutput - 侧面/背面全身肖像
- **逻辑**: 基于已生成的正面肖像生成一致的其他视角

### 关键设计

- **三视图系统**: 正面 → 侧面 → 背面的生成顺序
- **参考图链式生成**: 后续视角基于正面肖像，确保一致性
- **纯白背景**: 便于后续抠图和合成
- **全身居中构图**: 占据画面大部分区域，细节完整

### 优化建议

- ✅ **当前优势**: 三视图设计完善，链式生成保证一致性
- 🔄 **可优化项**:
  - 可以增加 3/4 视角肖像（电影中常用）
  - 考虑生成不同表情的肖像变体（微笑、严肃、惊讶等）
  - 可以添加质量验证步骤（检查是否正确生成了指定视角）
  - 考虑添加角色身高比例参考，便于后期合成

---

## 4. StoryboardArtist (分镜艺术家)

### 核心职责

将剧本转化为详细的分镜头脚本，是从文字到视觉的关键转换层。

### 主要方法

#### `design_storyboard()`

- **输入**: script (剧本), characters (角色列表), user_requirement
- **输出**: List[ShotBriefDescription] - 分镜头简要描述列表
- **逻辑流程**:
  1. 分析剧本场景，决定镜头数量和类型
  2. 为每个镜头设计:
     - 镜头尺寸 (shot_size): 远景/全景/中景/特写等
     - 拍摄角度 (angle): 平视/俯视/仰视等
     - 镜头高度 (camera_height)
     - 等效焦距 (lens_equiv_mm)
     - 运动方向 (screen_direction): 左 → 右/右 → 左/朝向/远离/静止
     - 转场方式 (transition_in/out)
     - 节奏 (beat): 慢/中/快
     - 预估时长 (duration_sec_estimate)
  3. 编写视觉描述和音频描述

#### `decompose_visual_description()`

- **输入**: shot_brief_desc, characters
- **输出**: ShotDescription - 包含首帧/末帧/运动描述的详细分镜
- **逻辑流程**:
  1. 将简要视觉描述拆解为三部分:
     - **首帧描述** (ff_desc): 镜头开始时的静态画面
     - **末帧描述** (lf_desc): 镜头结束时的静态画面
     - **运动描述** (motion_desc): 首末帧之间的动态变化
  2. 区分镜头运动和画面内元素运动
  3. 识别出现的角色索引
  4. 判断变化程度 (variation_type): large/medium/small
  5. 在运动描述中使用外观特征（而非名字）指代角色

### 关键设计特点

- **电影语言专业性**: 包含了完整的摄影参数（焦距、角度、运动等）
- **180 度/30 度法则支持**: 通过 screen_direction 等参数支持后续连续性检查
- **帧级分解**: 首帧/末帧分离设计为后续图像生成提供明确目标
- **角色引用规范**: 使用 `<角色名>` 标记，在运动描述中用外观特征引用

### 优化建议

- ✅ **当前优势**:
  - 电影摄影参数非常专业完整
  - 首帧/末帧分离的设计合理
  - 支持连续性规则检查
- 🔄 **可优化项**:
  - 可以添加景深信息（前景/中景/背景层次）
  - 考虑增加光线信息（自然光/人工光、色温等）
  - variation_type 可以更精细化（例如用数值表示变化程度）
  - 可以考虑添加"镜头优先级"标记，优先生成关键镜头

---

## 5. CameraImageGenerator (镜头图像生成器)

### 核心职责

构建镜头间的层级关系（摄影机树），并管理镜头过渡视频的生成。

### 主要方法

#### `construct_camera_tree()`

- **输入**: cameras (镜头列表), shot_descs (分镜描述)
- **输出**: List[Camera] - 带有父子关系的镜头树
- **逻辑流程**:
  1. 为每个镜头寻找"父镜头"（视野更广的镜头）
  2. 考虑因素:
     - **内容包含关系**: 父镜头的视野应包含子镜头
     - **镜头尺寸过渡**: 优先选择相邻尺寸，避免跳跃过大
     - **180 度法则**: 优先选择运动方向一致的父镜头
     - **时间邻近性**: 父镜头应在时间上接近子镜头
     - **焦距限制**: 避免焦距差异过大（超过 3 倍）
  3. 使用启发式算法作为兜底方案
  4. 标记父镜头无法完全覆盖的信息 (missing_info)
  5. 只允许一个镜头作为根节点（无父镜头）

#### `generate_transition_video()`

- **输入**: 两个镜头的视觉描述, 第一个镜头的首帧
- **输出**: VideoOutput - 过渡视频
- **逻辑**: 生成从父镜头到子镜头的平滑过渡视频

#### `get_new_camera_image()`

- **输入**: transition_video_path
- **输出**: ImageOutput - 新镜头的图像
- **逻辑**:
  1. 使用场景检测分割过渡视频
  2. 提取第二个场景的首帧作为新镜头图像
  3. 如果检测失败，使用过渡视频的末帧

### 关键设计

- **层级化镜头管理**: 树状结构反映了镜头间的包含关系
- **智能父镜头选择**: 综合考虑多个电影拍摄规则
- **过渡视频中介**: 利用视频生成的时间连续性来获得合理的新视角

### 优化建议

- ✅ **当前优势**:
  - 镜头树设计巧妙，符合电影制作实践
  - 多因素评分系统合理
  - 自动检测并标记问题（missing_info）
- 🔄 **可优化项**:
  - 可以考虑更复杂的评分权重调整
  - 对于 missing_info 情况，可以生成专门的"补全提示"
  - 可以添加"镜头可行性"预检查（某些镜头组合可能物理上不可行）
  - 考虑支持并行镜头（同一时刻的不同视角）

---

## 6. ReferenceImageSelector (参考图选择器)

### 核心职责

为每一帧图像的生成智能选择最相关的参考图像，并生成引导图像生成的文本提示。

### 主要方法

#### `select_reference_images_and_generate_prompt()`

- **输入**:
  - available_image_path_and_text_pairs: 可用的参考图列表（角色肖像+已生成的场景图）
  - frame_description: 目标帧的文本描述
  - style: 视觉风格
- **输出**:
  - reference_image_path_and_text_pairs: 选中的参考图（最多 8 张）
  - text_prompt: 生成的图像提示词
- **逻辑流程**:
  1. **预过滤阶段**（如果候选图超过 8 张）:
     - 使用纯文本模型快速筛选相关图像
  2. **多模态选择阶段**:
     - 使用支持图像输入的模型进行精细选择
     - 考虑因素:
       - 角色一致性（外貌、服装、姿态）
       - 环境一致性（场景、光照、氛围）
       - 风格一致性（视觉风格统一）
       - 构图相似性（同一镜头拍摄的画面优先）
       - 时间邻近性（最近生成的画面优先）
  3. **提示词生成**:
     - 为每个选中的参考图分配索引（Image 0, Image 1...）
     - 生成详细提示词，明确指出每个元素应参考哪张图
     - 包含视觉风格要求
  4. **降级策略**: 如果多模态失败，降级为纯文本选择
  5. **提示词验证和修复** (`_validate_prompt_mapping`):
     - 检查生成的提示词是否正确引用了所有参考图
     - 如果缺失引用，自动修复或重新生成

### 关键设计

- **两阶段过滤**: 先粗筛再精选，节省多模态模型调用成本
- **强制引用机制**: 确保生成的提示词明确引用每张参考图（"Image N"格式）
- **视角匹配**: 为角色选择最合适的视角肖像（正面/侧面/背面）
- **去重逻辑**: 避免选择重复信息的参考图

### 优化建议

- ✅ **当前优势**:
  - 两阶段筛选设计高效
  - 提示词验证机制完善
  - 降级策略保证鲁棒性
- 🔄 **可优化项**:
  - 可以添加参考图权重系统（有些图更重要）
  - 考虑缓存常用角色组合的参考图选择结果
  - 可以优化选择策略（例如使用 embedding 相似度预筛选）
  - 生成的提示词可以更结构化（分为角色描述、环境描述、风格描述等模块）

---

## 7. BestImageSelector (最佳图像选择器)

### 核心职责

从多个候选生成图像中选出最符合要求的一张。

### 主要方法

#### `__call__()`

- **输入**:
  - reference_image_path_and_text_pairs: 参考图及其描述
  - target_description: 目标图像的文本描述
  - candidate_image_paths: 候选图像路径列表
- **输出**: 最佳图像的路径
- **评估标准**:
  1. **角色一致性** (优先级最高):
     - 性别、种族、年龄
     - 面部特征、体型
     - 服装、发型
  2. **空间一致性**:
     - 角色相对位置（左右、前后）
     - 场景布局
     - 视角一致性
  3. **描述准确性**:
     - 是否包含描述中的关键元素
     - 动作、场景、物品是否准确
  4. **质量因素**:
     - 无白边、黑边
     - 无额外边框

### 关键设计

- **多候选生成策略**: 生成多张候选图（通常 3 张）再选最佳
- **多模态评估**: 同时对比参考图和候选图的视觉信息
- **客观评估**: 避免主观偏好，基于明确标准
- **重试机制**: 失败时降级为选择第一张候选

### 优化建议

- ✅ **当前优势**:
  - 评估标准清晰明确
  - 优先级合理（角色一致性最重要）
  - 有降级策略
- 🔄 **可优化项**:
  - 可以返回评分而非仅返回最佳图（便于调试和分析）
  - 考虑增加候选数量（例如 5-7 张）提高选择空间
  - 可以添加"都不满意"的判断，触发重新生成
  - 考虑引入自动化指标（CLIP 相似度、人脸识别等）辅助判断

---

## 8. Pipeline 流程概览

### Script2Video Pipeline

完整流程（7 个主要阶段）：

```
1. 提取角色 (Extract Characters)
   ↓
2. 生成角色肖像 (Generate Character Portraits)
   ↓
3. 设计分镜头 (Design Storyboard)
   ↓
4. 分解视觉描述 (Decompose Visual Descriptions)
   ↓
5. 构建镜头树 (Construct Camera Tree)
   ↓
6. 连续性检查 (Continuity Check - 180/30度规则)
   ↓
7. 并行生成帧和视频 (Generate Frames & Videos)
   ├─ 按镜头树生成首帧
   ├─ 选择参考图 (ReferenceImageSelector)
   ├─ 生成候选帧 (多张)
   ├─ 选择最佳帧 (BestImageSelector)
   └─ 生成视频
   ↓
8. 时间线渲染 (Timeline Rendering)
```

### Idea2Video Pipeline

在 Script2Video 之前增加：

```
1. 发展故事 (Develop Story)
   ↓
2. 编写剧本 (Write Script)
   ↓
3. [对每个场景执行 Script2Video Pipeline]
   ↓
4. 拼接场景视频
```

### 关键设计特点

#### 缓存机制

- 每个阶段的输出都保存为 JSON/图片/视频文件
- 重新运行时会跳过已完成的步骤
- 便于调试和增量生成

#### 异步并行

- 大量使用 `asyncio.gather()` 并行处理
- 使用 `asyncio.Event()` 管理依赖关系
- 例如：多个镜头的帧可以并行生成

#### 优先级系统

- priority_shot_idxs：标记作为其他镜头父镜头的重要镜头
- 优先生成这些镜头的首帧，解除下游依赖

#### 容错设计

- 各 Agent 都有重试机制（通常 3 次）
- 降级策略（例如多模态失败降级为纯文本）
- 连续性检查失败会终止生成（避免浪费资源）

---

## 9. 优化建议总结

### 架构层面

#### ✅ 已有优势

1. **模块化设计**: 每个 Agent 职责单一明确
2. **缓存系统**: 避免重复计算，支持增量生成
3. **异步并行**: 充分利用 I/O 等待时间
4. **专业性**: 深度结合电影制作理论

#### 🔄 可优化方向

1. **质量评估体系**

   - 在多个阶段引入质量评分
   - 自动检测并标记"可疑"输出
   - 建立反馈循环：质量不佳时自动重试或调整参数

2. **用户交互增强**

   - 在关键节点提供预览和确认机制
   - 允许用户微调某些参数（例如镜头数量、节奏等）
   - 提供"快速预览"模式（低质量快速生成）

3. **成本优化**

   - 智能预算分配（重要镜头高质量，次要镜头降低质量）
   - 参考图选择可以使用更便宜的 embedding 模型预筛选
   - 候选图数量可以根据重要性动态调整

4. **一致性增强**

   - 建立全局"记忆系统"，追踪角色状态变化
   - 增强角色外貌一致性验证（人脸识别、服装检测等）
   - 场景元素一致性检查（道具、环境等）

5. **创意控制**

   - 支持"关键帧锁定"（用户提供某些关键画面）
   - 风格迁移更细粒度控制
   - 支持分层风格（角色一种风格，背景另一种风格）

6. **性能监控**
   - 添加详细的耗时统计
   - 识别性能瓶颈
   - 自动优化执行策略

### 具体 Agent 优化优先级

| Agent                       | 优先级 | 建议优化点                     |
| --------------------------- | ------ | ------------------------------ |
| BestImageSelector           | 🔥 高  | 增加候选数量、引入自动指标     |
| ReferenceImageSelector      | 🔥 高  | 优化选择策略、参考图权重系统   |
| CharacterExtractor          | 🔥 高  | 角色关系图谱、服装变化追踪     |
| CameraImageGenerator        | 🟡 中  | 镜头可行性预检查、评分权重优化 |
| StoryboardArtist            | 🟡 中  | 景深/光线信息、镜头优先级      |
| CharacterPortraitsGenerator | 🟢 低  | 增加表情/角度变体              |
| Screenwriter                | 🟢 低  | 一致性检查、类型模板           |

---

## 总结

ViMax 的 Agent 系统设计体现了深厚的电影制作理论功底，从故事创作到最终视频渲染的全流程都有完善的支持。

**核心优势**：

- 专业的电影语言支持（180 度法则、镜头语言等）
- 完善的一致性保证机制（角色肖像、参考图系统）
- 高效的并行处理和缓存设计

**主要优化空间**：

- 质量评估和自动纠错
- 用户交互和创意控制
- 成本和性能优化

这个系统已经具备了产品化的基础，建议的优化方向主要集中在**提升生成质量稳定性**和**增强用户体验**两个方面。
